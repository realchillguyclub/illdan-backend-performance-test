name: Run K6 (manual pick)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref (branch/tag/SHA). ê¸°ë³¸ main'
        required: false
        default: 'main'
      script_path:
        description: 'ì‹¤í–‰í•  JS (ì˜ˆ: scripts/test/test.test.js)'
        required: true

env:
  REMOTE_BASE_PATH: ${{ secrets.REMOTE_BASE_PATH }}

jobs:
  run-k6-manual:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 1ï¸âƒ£ ì§€ì •í•œ ref(ë¸Œëœì¹˜/íƒœê·¸/SHA) ì²´í¬ì•„ì›ƒ
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.ref }}

      # ------------------------------------------------------------
      # 2ï¸âƒ£ script_path ìœ íš¨ì„± ê²€ì‚¬ (scripts/**.jsë§Œ í—ˆìš© + ìœ ì¼ ë§¤ì¹­)
      #    - rel_path: scripts/ ì´í›„ì˜ ìƒëŒ€ê²½ë¡œ (ì˜ˆ: todo/foo.js)
      #    - rel_dir : ìƒëŒ€ ë””ë ‰í„°ë¦¬ (ì˜ˆ: todo)
      # ------------------------------------------------------------
      - name: Validate script_path
        id: pick_script
        shell: bash
        run: |
          set -euo pipefail
          IN="${{ github.event.inputs.script_path }}"

          shopt -s nullglob globstar

          if [[ "$IN" == scripts/*.js || "$IN" == scripts/**/*.js ]]; then
            candidates=( $IN )
          else
            candidates=( scripts/**/"$IN" )
          fi

          filtered=()
          for f in "${candidates[@]}"; do
            [[ -f "$f" && "$f" == *.js ]] && filtered+=( "$f" )
          done
          candidates=( "${filtered[@]}" )

          if (( ${#candidates[@]} == 0 )); then
            echo "::error::ëŒ€ìƒ íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: $IN (scripts/** ì•„ë˜ ê²€ìƒ‰)"
            exit 1
          elif (( ${#candidates[@]} > 1 )); then
            echo "::error::ì—¬ëŸ¬ íŒŒì¼ì´ ë§¤ì¹­ë˜ì—ˆìŠµë‹ˆë‹¤. ì •í™•í•œ ê²½ë¡œë¡œ ì§€ì •í•˜ì„¸ìš”:"
            printf '%s\n' "${candidates[@]}"
            exit 1
          fi

          P="${candidates[0]}"

          WS="${GITHUB_WORKSPACE:-$PWD}"
          REAL_P="$(realpath "$P")"
          REAL_SCRIPTS="$(realpath "$WS/scripts")"
          case "$REAL_P" in
            "$REAL_SCRIPTS"/*) ;;  # OK
            *) echo "::error::scripts ë””ë ‰í„°ë¦¬ í•˜ìœ„ê°€ ì•„ë‹™ë‹ˆë‹¤: $REAL_P"; exit 1 ;;
          esac

          # scripts/ ì´í›„ ìƒëŒ€ê²½ë¡œ ê³„ì‚° (ì˜ˆ: todo/foo.js)
          REL_PATH="${P#scripts/}"
          REL_DIR="$(dirname "$REL_PATH")"
          BASENAME="$(basename "$P")"

          {
            echo "script_path=$P"
            echo "rel_path=$REL_PATH"
            echo "rel_dir=$REL_DIR"
            echo "basename=$BASENAME"
            echo "scripts_present=1"
          } >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # 3ï¸âƒ£ ì›ê²© k6 ë””ë ‰í„°ë¦¬ ì „ì²´ ë¹„ìš°ê¸° (í•˜ìœ„ ë””ë ‰í† ë¦¬ê¹Œì§€ ì „ë¶€ ì‚­ì œ)
      # ------------------------------------------------------------
      - name: Clean remote k6 directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            bash -lc '
              set -euo pipefail
              BASE="${{ env.REMOTE_BASE_PATH }}/k6"
              echo "ğŸ§¹ Purging: ${BASE}"
              mkdir -p "${BASE}"
              # í•˜ìœ„ ëª¨ë“  íŒŒì¼/ë””ë ‰í† ë¦¬ ì‚­ì œ (k6 ìì²´ëŠ” ìœ ì§€)
              find "${BASE}" -mindepth 1 -maxdepth 1 -exec rm -rf {} +
              ls -la "${BASE}" || true
            '

      # ------------------------------------------------------------
      # 4ï¸âƒ£ ì„ íƒëœ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒëŒ€ê²½ë¡œ ë³´ì¡´í•´ ì—…ë¡œë“œ (scripts/ ì˜ë¼ì„œ k6/ ì•„ë˜ë¡œ)
      # ------------------------------------------------------------
      - name: Upload selected script (preserve relative path)
        if: ${{ steps.pick_script.outputs.scripts_present == '1' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: ${{ steps.pick_script.outputs.script_path }}
          target: ${{ env.REMOTE_BASE_PATH }}/k6
          strip_components: 1   # â† scripts/ í•œ ë‹¨ê³„ ì œê±° â†’ k6/<rel_path>ë¡œ ì—…ë¡œë“œ
          overwrite: true

      # ------------------------------------------------------------
      # 5ï¸âƒ£ EC2ì—ì„œ docker-composeë¡œ k6 ì‹¤í–‰ (k6/ ë‹¤ìŒì— rel_path ê·¸ëŒ€ë¡œ ì‹¤í–‰)
      #     - /scripts ê°€ í˜¸ìŠ¤íŠ¸ì˜ ${REMOTE_BASE_PATH}/k6 ì— ë§ˆìš´íŠ¸ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
      # ------------------------------------------------------------
      - name: Run k6 on EC2 (with influxdb output)
        if: ${{ steps.pick_script.outputs.scripts_present == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            bash -lc '
              set -euo pipefail
              cd "${{ env.REMOTE_BASE_PATH }}"

              REL_PATH="${{ steps.pick_script.outputs.rel_path }}"   # ex) todo/history-calendar.test.js
              HOST_SCRIPT_PATH="k6/${REL_PATH}"

              echo "â³ Waiting for ${HOST_SCRIPT_PATH} to appear..."
              COUNT=0
              while [ ! -f "${HOST_SCRIPT_PATH}" ]; do
                if [ "$COUNT" -ge 10 ]; then
                  echo "::error::File not found after 10 seconds: ${HOST_SCRIPT_PATH}"
                  echo "Directory contents of k6:"; ls -Rla k6/ || true
                  exit 1
                fi
                sleep 1; COUNT=$((COUNT+1))
              done
              echo "âœ… Found ${HOST_SCRIPT_PATH}"

              echo "ğŸš€ Running k6: /scripts/${REL_PATH}"
              docker-compose run --rm k6 run -o influxdb=http://influxdb:8086/k6 --quiet "/scripts/${REL_PATH}"
            '
