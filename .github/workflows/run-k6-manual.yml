name: Run K6 (manual pick)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref (branch/tag/SHA). ê¸°ë³¸ main'
        required: false
        default: 'main'
      script_path:
        description: 'ì‹¤í–‰í•  JS (ì˜ˆ: scripts/test/test.test.js)'
        required: true

env:
  REMOTE_BASE_PATH: ${{ secrets.REMOTE_BASE_PATH }}

jobs:
  run-k6-manual:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 1ï¸âƒ£ ì§€ì •í•œ ref(ë¸Œëœì¹˜/íƒœê·¸/SHA) ì²´í¬ì•„ì›ƒ
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.ref }}

      # ------------------------------------------------------------
      # 2ï¸âƒ£ script_path ìœ íš¨ì„± ê²€ì‚¬
      #    - scripts/ í•˜ìœ„ì˜ .js íŒŒì¼ë§Œ í—ˆìš©
      #    - ì§€ì •í•œ ref ê¸°ì¤€ìœ¼ë¡œ íŒŒì¼ì´ ì¡´ì¬í•´ì•¼ í•¨
      # ------------------------------------------------------------
      - name: Validate script_path
        id: pick_script
        shell: bash
        run: |
          set -euo pipefail
          P="${{ github.event.inputs.script_path }}"

          # 1) í˜•ì‹ ì œí•œ: scripts/ ë¡œ ì‹œì‘í•˜ê³  .js ë¡œ ëë‚˜ì•¼ í•¨
          [[ "$P" =~ ^scripts/.+\.js$ ]] || { echo "::error::scripts/ í•˜ìœ„ .jsë§Œ í—ˆìš©: $P"; exit 1; }

          # 2) íŒŒì¼ ì¡´ì¬
          [[ -f "$P" ]] || { echo "::error::íŒŒì¼ ì—†ìŒ: $P"; exit 1; }

          # 3) ì‹¤ì œ ê²½ë¡œê°€ scripts/ í•˜ìœ„ì¸ì§€ ê²€ì¦
          WS="${GITHUB_WORKSPACE:-$PWD}"
          REAL_P="$(realpath "$P")"
          REAL_SCRIPTS="$(realpath "$WS/scripts")"
          case "$REAL_P" in
            "$REAL_SCRIPTS"/*) ;;  # OK
            *) echo "::error::scripts ë””ë ‰í„°ë¦¬ í•˜ìœ„ê°€ ì•„ë‹™ë‹ˆë‹¤: $REAL_P"; exit 1 ;;
          esac

          echo "script_path=$P" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # 3ï¸âƒ£ ì›ê²© k6 ë””ë ‰í„°ë¦¬ì˜ ê¸°ì¡´ JS ì •ë¦¬ (JSë§Œ ì‚­ì œ, ê¸°íƒ€ íŒŒì¼ ë³´ì¡´)
      # ------------------------------------------------------------
      - name: Clean old JS (remote)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            bash -lc '
              set -euo pipefail
              echo "ğŸ§¹ Removing old JS files in ${{ env.REMOTE_BASE_PATH }}/k6"
              find "${{ env.REMOTE_BASE_PATH }}/k6" -maxdepth 1 -type f -name "*.js" -print -delete || true
            '

      # ------------------------------------------------------------
      # 4ï¸âƒ£ ì„ íƒëœ ìŠ¤í¬ë¦½íŠ¸ë§Œ ì›ê²© k6 ë””ë ‰í„°ë¦¬ë¡œ ì „ì†¡
      # ------------------------------------------------------------
      - name: Upload selected script
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: ${{ steps.pick_script.outputs.script_path }}
          target: ${{ env.REMOTE_BASE_PATH }}/k6

      # ------------------------------------------------------------
      # 5ï¸âƒ£ EC2ì—ì„œ docker-composeë¥¼ í†µí•´ k6 ì‹¤í–‰
      #     - íŒŒì¼ì´ ì¡´ì¬í•˜ê³ , ë¹„ì–´ìˆì§€ ì•Šì€ì§€ 10ì´ˆê°„ ëŒ€ê¸°
      # ------------------------------------------------------------
      - name: Run k6 on EC2 (with influxdb output)
        if: ${{ steps.pick_script.outputs.scripts_present == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            bash -lc '
              set -euo pipefail
              cd "${{ env.REMOTE_BASE_PATH }}"    

              # 1. íŒŒì¼ ê²½ë¡œ ì •ì˜
              SCRIPT_FILE=$(basename "${{ steps.pick_script.outputs.script_path }}")
              HOST_SCRIPT_PATH="k6/${SCRIPT_FILE}"

              # -------------------------------------------------
              # ğŸ”„ íŒŒì¼ì´ ì¡´ì¬í•  ë•Œê¹Œì§€ 10ì´ˆê°„ ëŒ€ê¸°
              #    (-f: íŒŒì¼ ì¡´ì¬)
              # -------------------------------------------------
              echo "â³ Waiting for script file to exist at ${HOST_SCRIPT_PATH}..."
              COUNT=0
              while [ ! -f "${HOST_SCRIPT_PATH}" ]; do
                if [ "$COUNT" -ge 10 ]; then
                  echo "::error::File not found after 10 seconds: ${HOST_SCRIPT_PATH}"
                  echo "Directory contents:"
                  ls -l k6/
                  exit 1
                fi
                echo "File not yet found, retrying in 1s... (Attempt $((COUNT+1)))"
                sleep 1
                COUNT=$((COUNT + 1))
              done
              echo "âœ… File exists. Proceeding with k6 run."
              # -------------------------------------------------

              # 3. k6 í…ŒìŠ¤íŠ¸ ì‹¤í–‰
              echo "ğŸš€ Running k6 test: ${SCRIPT_FILE}"

              docker-compose run --rm k6 run -o influxdb=http://influxdb:8086/k6 --quiet /scripts/${SCRIPT_FILE}
            '