name: Run K6 Test on PR (single script only)

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'scripts/**/*.js'

env:
  REMOTE_BASE_PATH: ${{ secrets.REMOTE_BASE_PATH }}

jobs:
  run-k6-single:
    runs-on: ubuntu-latest

    steps:
      # 1) ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) scripts/** ì•„ë˜ JS íŒŒì¼ì´ ì •í™•íˆ 1ê°œì¸ì§€ í™•ì¸í•˜ê³ , basename ì¶”ì¶œ
      - name: Ensure exactly one JS script exists
        id: pick_script
        shell: bash
        run: |
          set -euo pipefail

          # í•˜ìœ„ í´ë” í¬í•¨ íƒìƒ‰
          mapfile -t FILES < <(find scripts -type f -name '*.js' | sort -u)
          COUNT=${#FILES[@]}
          echo "Found JS files: ${COUNT}"

          if [ "$COUNT" -ne 1 ]; then
            echo "::error::scripts í´ë”ì—ëŠ” JS íŒŒì¼ì´ ì •í™•íˆ 1ê°œë§Œ ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤. í˜„ì¬ ê°œìˆ˜=${COUNT}"
            echo "scripts_present=${COUNT}" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          ABS_PATH="${FILES[0]}"
          BASENAME="$(basename "${ABS_PATH}")"

          echo "script_path=${ABS_PATH}" >> "$GITHUB_OUTPUT"
          echo "script_basename=${BASENAME}" >> "$GITHUB_OUTPUT"
          echo "scripts_present=1" >> "$GITHUB_OUTPUT"

      # 3) ì›ê²© k6 ë””ë ‰í„°ë¦¬ì˜ ê¸°ì¡´ JS ì •ë¦¬
      - name: Clean old JS in remote k6 dir
        if: ${{ steps.pick_script.outputs.scripts_present == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            bash -lc '
              set -euo pipefail
              BASE="${{ env.REMOTE_BASE_PATH }}/k6"
              echo "ğŸ§¹ Removing old JS files recursively in ${BASE}"
              find "${BASE}" -type f -name "*.js" -print -delete || true
              find "${BASE}" -type d -empty -print -delete || true
            '

      # 4) ë‹¨ì¼ íŒŒì¼ë§Œ ì›ê²©ìœ¼ë¡œ ì „ì†¡ (ìƒëŒ€ê²½ë¡œ ì œê±° â†’ íŒŒì¼ëª…ë§Œ)
      - name: Transfer script to EC2 (flatten to filename)
        if: ${{ steps.pick_script.outputs.scripts_present == '1' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: ${{ steps.pick_script.outputs.script_path }}
          # targetì„ ë””ë ‰í„°ë¦¬/íŒŒì¼ëª… í˜•íƒœë¡œ ì§€ì • â†’ ìƒëŒ€ê²½ë¡œ ì—†ì´ í•´ë‹¹ íŒŒì¼ëª…ìœ¼ë¡œ ì—…ë¡œë“œ
          target: ${{ env.REMOTE_BASE_PATH }}/k6/${{ steps.pick_script.outputs.script_basename }}

      # 5) docker-composeë¡œ k6 ì‹¤í–‰ (/scripts/<íŒŒì¼ëª…> ê¸°ì¤€)
      - name: Run k6 on EC2 (with influxdb output)
        if: ${{ steps.pick_script.outputs.scripts_present == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            bash -lc '
              set -euo pipefail
              cd "${{ env.REMOTE_BASE_PATH }}"

              BASENAME="${{ steps.pick_script.outputs.script_basename }}"
              HOST_SCRIPT_PATH="k6/${BASENAME}"

              echo "â³ Waiting for ${HOST_SCRIPT_PATH}..."
              COUNT=0
              while [ ! -f "${HOST_SCRIPT_PATH}" ]; do
                if [ "$COUNT" -ge 10 ]; then
                  echo "::error::File not found after 10 seconds: ${HOST_SCRIPT_PATH}"
                  echo "Directory contents of k6/:"
                  ls -la k6/ || true
                  exit 1
                fi
                sleep 1
                COUNT=$((COUNT+1))
              done

              echo "âœ… File exists. Running k6: /scripts/${BASENAME}"
              docker-compose run --rm k6 run -o influxdb=http://influxdb:8086/k6 --quiet "/scripts/${BASENAME}"
            '
