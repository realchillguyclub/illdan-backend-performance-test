name: Run K6 Test on PR (single script only)

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'scripts/**/*.js'

env:
  REMOTE_BASE_PATH: ${{ secrets.REMOTE_BASE_PATH }}

jobs:
  run-k6-single:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 1ï¸âƒ£ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # 2ï¸âƒ£ scripts í´ë” ë‚´ JS íŒŒì¼ ê°œìˆ˜ë¥¼ í™•ì¸
      #     - ì‹¤ì œ PR HEAD ê¸°ì¤€ìœ¼ë¡œ ì¡´ì¬í•˜ëŠ” íŒŒì¼ ê°œìˆ˜ë§Œ ê³„ì‚°
      #     - ë”± 1ê°œì—¬ì•¼ í†µê³¼, ì•„ë‹ˆë©´ ì˜¤ë¥˜ ë°œìƒ
      # ------------------------------------------------------------
      - name: Ensure exactly one JS script exists
        id: pick_script
        shell: bash
        run: |
          set -euo pipefail

          # scripts í´ë” ë‚´ JS íŒŒì¼ ëª©ë¡ ì¶”ì¶œ
          mapfile -t FILES < <(find scripts -type f -name '*.js' | sort -u)
          COUNT=${#FILES[@]}
          echo "scripts/**/*.js found: ${COUNT}"

          # íŒŒì¼ì´ ì •í™•íˆ 1ê°œê°€ ì•„ë‹ˆë©´ ì—ëŸ¬
          if [ "$COUNT" -ne 1 ]; then
            echo "::error::scripts í´ë”ì—ëŠ” JS íŒŒì¼ì´ ì •í™•íˆ 1ê°œë§Œ ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤. í˜„ì¬ ê°œìˆ˜=${COUNT}"
            echo "scripts_present=${COUNT}" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          # ì •í™•íˆ 1ê°œë©´ ê²½ë¡œë¥¼ ì¶œë ¥ ë³€ìˆ˜ë¡œ ì „ë‹¬
          echo "script_path=${FILES[0]}" >> "$GITHUB_OUTPUT"
          echo "scripts_present=1" >> "$GITHUB_OUTPUT"
          
      # 3ï¸âƒ£ ê¸°ì¡´ JS ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ì •ë¦¬
      - name: Clean old JS in remote k6 dir
        if: ${{ steps.pick_script.outputs.scripts_present == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            bash -lc '
              set -euo pipefail
              echo "ğŸ§¹ Removing old JS files in ${{ env.REMOTE_BASE_PATH }}/k6"
              find "${{ env.REMOTE_BASE_PATH }}/k6" -maxdepth 1 -type f -name "*.js" -print -delete || true
            '

      # ------------------------------------------------------------
      # 3ï¸âƒ£ EC2ë¡œ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì„ ì„ì‹œ íŒŒì¼(.tmp)ë¡œ ì „ì†¡
      # ------------------------------------------------------------
      - name: Transfer script to EC2 (as .tmp file)
        if: ${{ steps.pick_script.outputs.scripts_present == '1' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: ${{ steps.pick_script.outputs.script_path }}
          target: ${{ env.REMOTE_BASE_PATH }}/k6
          strip_components: 1
          rename: $(basename ${{ steps.pick_script.outputs.script_path }}).tmp

      # ------------------------------------------------------------
      # 4ï¸âƒ£ ì›ìì  êµì²´(mv) â¡ï¸ k6 ì‹¤í–‰ â¡ï¸ ìë™ ì •ë¦¬(trap)
      # ------------------------------------------------------------
      - name: Atomically Replace, Run k6, and Cleanup
        if: ${{ steps.pick_script.outputs.scripts_present == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            bash -lc '
              set -euo pipefail
              cd "${{ env.REMOTE_BASE_PATH }}"

              # 1. íŒŒì¼ ê²½ë¡œ ì •ì˜
              SCRIPT_FILE=$(basename "${{ steps.pick_script.outputs.script_path }}")
              HOST_SCRIPT_PATH="k6/${SCRIPT_FILE}"
              HOST_TEMP_PATH="k6/${SCRIPT_FILE}.tmp"

              # 2. ğŸ§¹ ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ ì‹œ ë¬´ì¡°ê±´ ì‹¤í–‰ë  ì •ë¦¬ í•¨ìˆ˜ ë“±ë¡
              #    (ì„±ê³µ/ì‹¤íŒ¨/ì˜¤ë¥˜ ëª¨ë‘ í¬í•¨)
              cleanup() {
                echo "ğŸ§¹ Cleaning up script files..."
                rm -f "${HOST_SCRIPT_PATH}"
                rm -f "${HOST_TEMP_PATH}"
                echo "âœ… Cleanup complete."
              }
              trap cleanup EXIT

              # 3. âš›ï¸ ì›ìì  êµì²´ ì‹¤í–‰
              echo "âš›ï¸ Atomically moving ${HOST_TEMP_PATH} to ${HOST_SCRIPT_PATH}"
              mv -f "${HOST_TEMP_PATH}" "${HOST_SCRIPT_PATH}"
              echo "âœ… File replaced."

              # 4. ğŸš€ k6 í…ŒìŠ¤íŠ¸ ì‹¤í–‰
              #    (trapì´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, ì´ ëª…ë ¹ì´ ì‹¤íŒ¨í•´ë„ cleanupì€ ì‹¤í–‰ë¨)
              echo "ğŸš€ Running k6 test: ${SCRIPT_FILE}"
              docker-compose run --rm k6 run \
                -o influxdb=http://influxdb:8086/k6 \
                "/scripts/${SCRIPT_FILE}"
            
              echo "K6 test finished successfully."
            '